{% extends "homepage/base.html" %}
{% load static %}

{% block title %}
    <title>Home Page</title>
{% endblock %}

{% block extra_css %}
    <style>
        .sold-out {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }

        .sold-out:hover {
            transform: none;
        }

        .overplay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            top: 0;
            left: 0;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Hero Section Begin -->
    <section class="hero">
        <div class="container">
            <div class="hero__slider owl-carousel">
                {% for game_hero in items.game_heros %}
                    <div class="hero__items set-bg" data-setbg="{{ gamehero.image.url }}">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="hero__text">
                                    <h2>Fate / Stay Night: Unlimited Blade Works</h2>
                                    <p>After 30 days of travel across the world...</p>
                                    <a href="#"><span>Buy Now</span></a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>
    <!-- Hero Section End -->

    <!-- Product Section Begin -->
    <section class="product spad">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="trending__product">
                        <div class="row">
                            <div class="col-lg-8 col-md-8 col-sm-8">
                                <div class="section-title">
                                    <h4>Trending Now</h4>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4">
                                <div class="btn__all">
                                    <a href="#" class="primary-btn">View All <span class="arrow_right"></span></a>
                                </div>
                            </div>
                        </div>
                        <div class="scroll-wrapper" id="trending-wrapper">
                            <button class="scroll-btn left-btn" onclick="customScrollLeft('trending')">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <div class="product-list" id="trending-product-list">
                                {% for game in items.games %}
                                    <div class="col-lg-3 col-md-4 col-sm-6 col-12 product-card">
                                        {% if game.status == 'base' %}
                                            <a class="item-click" game-pk="{{ game.pk }}" href="{% url 'game_details' game.pk %}">
                                                <div class="product__item">
                                                    {% if game.quantity > 0 %}
                                                        <div class="product__item__pic set-bg" data-setbg="{{ game.image.url }}"></div>
                                                    {% else %}
                                                        <div class="product__item__pic set-bg sold-out" data-setbg="{{ game.image.url }}">
                                                            <div class="overplay"></div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="product__item__text">
                                                    {% if game.status == 'base' %}
                                                        <span class="base-game">Base Game</span>
                                                    {% else %}
                                                        <span class="base-game">Downloadable Content</span>
                                                    {% endif %}
                                                    
                                                    <h5 class="line-clamp">{{ game.name }}</h5>
                                                    <span style="font-size: 12px;" class="base-game">{{ game.rating|capfirst }}</span>
                                                </div>
                                                <div class="price-section">
                                                    {% if game.discount > 0 %}
                                                        <span class="sale">-{{ game.discount }}%</span>
                                                        <span class="origin-price">${{ game.price }}</span>
                                                    {% endif %}
                                                    <span class="current-price">${{ game.discounted_price|floatformat:2 }}</span>
                                                </div>
                                            </a>
                                        {% else %}
                                            <a class="item-click" game-pk="{{ game.pk }}" href="{% url 'dlc-details' game.pk %}">
                                                <div class="product__item">
                                                    {% if game.quantity > 0 %}
                                                        <div class="product__item__pic set-bg" data-setbg="{{ game.image.url }}"></div>
                                                    {% else %}
                                                        <div class="product__item__pic set-bg sold-out" data-setbg="{{ game.image.url }}">
                                                            <div class="overplay"></div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="product__item__text">
                                                    {% if game.status == 'base' %}
                                                        <span class="base-game">Base Game</span>
                                                    {% else %}
                                                        <span class="base-game">Downloadable Content</span>
                                                    {% endif %}
                                                    
                                                    <h5 class="line-clamp">{{ game.name }}</h5>
                                                    <span style="font-size: 12px;" class="base-game">{{ game.rating|capfirst }}</span>
                                                </div>
                                                <div class="price-section">
                                                    {% if game.discount > 0 %}
                                                        <span class="sale">-{{ game.discount }}%</span>
                                                        <span class="origin-price">${{ game.price }}</span>
                                                    {% endif %}
                                                    <span class="current-price">${{ game.discounted_price|floatformat:2 }}</span>
                                                </div>
                                            </a>
                                        {% endif %}
                                       
                                    </div>
                                {% endfor %}
                            </div>
                            <button class="scroll-btn right-btn" onclick="customScrollRight('trending')">
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                     <!-- Sale Section Begin -->
                    <div class="sale__product mt-5">
                        <div class="row">
                            <div class="col-lg-8 col-md-8 col-sm-8">
                                <div class="section-title">
                                    <h4>Sale</h4>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4">
                                <div class="btn__all">
                                    <a href="#" class="primary-btn">View All <span class="arrow_right"></span></a>
                                </div>
                            </div>
                        </div>
                        <div class="scroll-wrapper" id="sale-wrapper">
                            <button class="scroll-btn left-btn" onclick="customScrollLeft('sale')">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <div class="product-list" id="sale-product-list">
                                {% for game in games %}
                                    {% if game.discount > 0 %}
                                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 product-card">
                                            <a href="{% url 'game_details' game.pk %}">
                                                <div class="product__item">
                                                    {% if game.quantity > 0 %}
                                                        <div class="product__item__pic set-bg" data-setbg="{{ game.image.url }}"></div>
                                                    {% else %}
                                                        <div class="product__item__pic set-bg sold-out" data-setbg="{{ game.image.url }}">
                                                            <div class="overplay"></div>
                                                            {% comment %} <img class="sold-out-img" src="{% static 'games/images/sold_out.png' %}" alt=""> {% endcomment %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="product__item__text">
                                                    <span class="base-game">Base Game</span>
                                                    <h5 class="line-clamp">{{ game.name }}</h5>
                                                </div>
                                                <div class="price-section">
                                                    <span class="sale">-{{ game.discount }}%</span>
                                                    <span class="origin-price">${{ game.price }}</span>
                                                    <span class="current-price">${{ game.discounted_price|floatformat:2 }}</span>
                                                </div>
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <button class="scroll-btn right-btn" onclick="customScrollRight('sale')">
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Sale Section End -->
                </div>
            </div>
        </div>
    </section>
    <!-- Product Section End -->

    <script>
        function getProductWidth(card) {
            const style = window.getComputedStyle(card);
            const width = card.offsetWidth;
            const marginRight = parseFloat(style.marginRight);
            return width + marginRight;
        }
        
        const scrollStep = 4;
        const state = {
            trending: 0,
            sale: 0
        };
        
        function updateButtonVisibility(prefix, totalProducts, productWidth) {
            const leftBtn = document.querySelector(`#${prefix}-wrapper .left-btn`);
            const rightBtn = document.querySelector(`#${prefix}-wrapper .right-btn`);
            const currentIndex = state[prefix];
        
            leftBtn.style.display = currentIndex === 0 ? 'none' : 'block';
            rightBtn.style.display = currentIndex >= totalProducts - scrollStep ? 'none' : 'block';
        }
        
        function customScrollLeft(prefix) {
            const container = document.getElementById(`${prefix}-product-list`);
            const card = container.querySelector('.product-card');
            const totalProducts = container.querySelectorAll('.product-card').length;
            const productWidth = getProductWidth(card);
        
            state[prefix] = Math.max(0, state[prefix] - scrollStep);
            container.style.transform = `translateX(-${state[prefix] * productWidth}px)`;
            updateButtonVisibility(prefix, totalProducts, productWidth);
        }
        
        function customScrollRight(prefix) {
            const container = document.getElementById(`${prefix}-product-list`);
            const card = container.querySelector('.product-card');
            const totalProducts = container.querySelectorAll('.product-card').length;
            const productWidth = getProductWidth(card);
        
            const maxIndex = totalProducts - scrollStep;
            state[prefix] = Math.min(maxIndex, state[prefix] + scrollStep);
            container.style.transform = `translateX(-${state[prefix] * productWidth}px)`;
            updateButtonVisibility(prefix, totalProducts, productWidth);
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            ['trending', 'sale'].forEach(prefix => {
                const container = document.getElementById(`${prefix}-product-list`);
                const card = container?.querySelector('.product-card');
                if (container && card) {
                    const totalProducts = container.querySelectorAll('.product-card').length;
                    const productWidth = getProductWidth(card);
                    updateButtonVisibility(prefix, totalProducts, productWidth);
                }
            });
        });        
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectedItems = [];
        
            document.querySelectorAll('.item-click').forEach(item => {
                item.addEventListener('click', async function (e) {
                    e.preventDefault();
                    
                    const gamePk = this.getAttribute('game-pk');
                    const userId = user_pk;
                    
                    selectedItems.push({
                        item_id: gamePk,
                        event_type: 'view',
                        timestamp: Math.floor(Date.now() / 1000)
                    });
                    
                    await sendInteractions(userId, selectedItems);
                    
                    window.location.href = this.href;
                });
            });
        });
    </script>
{% endblock %}