{% extends "homepage/base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'users/css/profile.css' %}">
{% endblock %}


{% block content %}
    <!-- Profile Header Begin -->
    <section class="profile-header set-bg" data-setbg="{% static 'homepage/img/normal-breadcrumb.jpg' %}">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="profile-header__content">
                        <div class="profile-avatar">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="Profile Image">
                            {% else %}
                                <div class="profile-avatar__placeholder">
                                    <i class="fa fa-user"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <h2>{{ user.username }}</h2>
                            <p>{{ user.email }}</p>
                            <div class="profile-stats">
                                <div class="stat">
                                    <span class="stat-label">Purchases</span>
                                    <span class="stat-value">{{ user.owned_games.count }}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Member Since</span>
                                    <span class="stat-value">{{ user.created_at|date:"M Y" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Profile Header End -->

    <!-- Profile Content Begin -->
    <section class="profile-content spad">
        <div class="container">
            <div class="profile-tabs">
                <ul class="nav-tabs">
                    <li class="tab-item active" data-tab="account">
                        <i class="fa fa-user"></i>Account
                    </li>
                    <li class="tab-item" data-tab="purchases">
                        <i class="fa fa-shopping-cart"></i>Library
                    </li>
                    <li class="tab-item" data-tab="wishlist">
                        <i class="fa fa-heart"></i>Wishlist
                    </li>
                </ul>
            </div>
            
            <div class="tab-content">
                <!-- Account Tab -->
                <div class="tab-pane active" id="account">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="profile-card">
                                <div class="profile-card__header">
                                    <h3>Profile Information</h3>
                                </div>
                                <div class="profile-card__body">
                                    <form action="" method="POST">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <label>Username</label>
                                            <div class="input__item">
                                                {{ form.username }}
                                                <span class="fa fa-user"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Email Address</label>
                                            <div class="input__item">
                                                {{ form.email }}
                                                <span class="fa-solid fa-envelope"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Full Name (Optional)</label>
                                            <div class="input__item">
                                                {{ form.full_name }}
                                                <span class="fa fa-id-card"></span>
                                            </div>
                                        </div>
                                        <button type="submit" class="site-btn">Update Profile</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="profile-card">
                                <div class="profile-card__header">
                                    <h3>Profile Picture</h3>
                                </div>
                                <div class="profile-card__body text-center">
                                    <div class="profile-picture-upload">
                                        {% if user.profile_image %}
                                            <img src="{{ user.profile_image.url }}" alt="Profile Image">
                                        {% else %}
                                            <div class="profile-picture-placeholder">
                                                <i class="fa fa-user"></i>
                                            </div>
                                        {% endif %}
                                        <div class="upload-actions">
                                            <label for="profile-image-upload" class="btn-upload">
                                                <i class="fa fa-camera"></i> Change Picture
                                            </label>
                                            <input id="profile-image-upload" type="file" accept="image/*" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Purchases Tab -->
                <div class="tab-pane" id="purchases">
                    <div class="profile-card">
                        <div class="profile-card__header">
                            <h3>Purchase History</h3>
                            <div class="search-bar mb-3">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search your games...">
                            </div>
                        </div>
                        <div class="profile-card__body">
                            {% if user.owned_games.exists %}
                                <div class="purchase-history">
                                    {% for user_game in user_games %}
                                        <div class="purchase-product">
                                            <div class="product-image">
                                                <img src="{{ user_game.game.image.url }}" alt="{{ user_game.game.name }}">
                                            </div>
                                            <div class="product-info">
                                                <a style="display: block;" href="{% url 'transaction-detail' user_game.transaction.pk %}"><h5>{{ user_game.game.name }}</h5></a>
                                                <div class="product-key">
                                                    <span class="key-label">Game Key:</span>
                                                    <span class="key-value">{{ user_game.key }}</span>
                                                    <button class="copy-key" data-key="{{ user_game.key }}">
                                                        <i class="fa fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fa fa-shopping-cart"></i>
                                    </div>
                                    <h4>No purchases yet</h4>
                                    <p>Your purchase history will appear here once you buy something.</p>
                                    <a href="{% url 'home' %}" class="site-btn">Browse Store</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Wishlist Tab -->
                <div class="tab-pane" id="wishlist">
                    <div class="profile-card">
                        <div class="profile-card__header">
                            <h3>My Wishlist</h3>
                        </div>
                        <div class="profile-card__body">
                            {% if user.wishlist.exists %}
                                <div class="wishlist-items">
                                    <div class="row">
                                        {% for item in user.wishlist.all %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="wishlist-item">
                                                    <button class="remove-wishlist" data-id="{{ item.id }}">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                    <div class="wishlist-image">
                                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                                    </div>
                                                    <div class="wishlist-info">
                                                        <h4>{{ item.product.name }}</h4>
                                                        <p>{{ item.product.platform }}</p>
                                                        <div class="wishlist-price">${{ item.product.price }}</div>
                                                        <a href="{% url 'product_detail' item.product.id %}" class="site-btn">View Details</a>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fa fa-heart"></i>
                                    </div>
                                    <h4>Your wishlist is empty</h4>
                                    <p>Save games you're interested in to your wishlist.</p>
                                    <a href="{% url 'home' %}" class="site-btn">Browse Store</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Profile Content End -->
    <script src="{% static 'users/js/main.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const purchaseHistoryContainer = document.querySelector('.purchase-history');
            let originalContent = purchaseHistoryContainer ? purchaseHistoryContainer.innerHTML : '';
            let currentQuery = '';
        
            searchInput.addEventListener('input', function () {
                const query = searchInput.value.trim();
                currentQuery = query;
        
                if (query === '') {
                    purchaseHistoryContainer.innerHTML = originalContent;
                    return;
                }
        
                fetch(`/api/search/user-games/?query=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (query !== currentQuery) return;
        
                        purchaseHistoryContainer.innerHTML = '';
        
                        if (data.length === 0) {
                            purchaseHistoryContainer.innerHTML = '<p>No result</p>';
                            return;
                        }
        
                        data.forEach(item => {
                            const gameHTML = `
                                <div class="purchase-product">
                                    <div class="product-image">
                                        <img src="${item.game.image}" alt="${item.game.name}">
                                    </div>
                                    <div class="product-info">
                                        <a style="display: block;" href="/transaction/${item.transaction.id}/"><h5>${item.game.name}</h5></a>
                                        <div class="product-key">
                                            <span class="key-label">Game Key:</span>
                                            <span class="key-value">${item.key.key}</span>
                                            <button class="copy-key" data-key="hidden">
                                                <i class="fa fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            purchaseHistoryContainer.insertAdjacentHTML('beforeend', gameHTML);
                        });
                    })
                    .catch(error => {
                        if (query === currentQuery) {
                            purchaseHistoryContainer.innerHTML = '<p>Error loading results</p>';
                        }
                        console.error('Error during fetch:', error);
                    });
            });
        });
    </script>               
{% endblock %}
