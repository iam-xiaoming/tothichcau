{% extends "homepage/base.html" %}
{% load static %}

{% block title %}
    <title>Game Detail</title>
{% endblock %}

{% block content %}
    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Anime Section Begin -->g
    <section class="anime-details spad">
        <div class="container">
            <div class="anime__details__content">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="anime__details__pic set-bg" data-setbg="{{ game.image.url }}">
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="anime__details__text">
                            <div class="anime__details__title">
                                <h3>{{ game.name }}</span>
                            </div>
                            <div class="anime__details__rating">
                                <div class="rating">
                                    <a href="#"><i class="fa fa-star"></i></a>
                                    <a href="#"><i class="fa fa-star"></i></a>
                                    <a href="#"><i class="fa fa-star"></i></a>
                                    <a href="#"><i class="fa fa-star"></i></a>
                                    <a href="#"><i class="fa fa-star-half-o"></i></a>
                                </div>
                                <span>1.029 Votes</span>
                            </div>
                            <p>{{ game.description }}</p>
                            <div class="anime__details__widget">
                                <div class="row">
                                    <div class="col-lg-6 col-md-6">
                                        <ul>
                                            <li><span>Publisher:</span>{{ game.publisher }}</li>
                                            <li><span>Date released:</span>{{ game.release_date }}</li>
                                            <li><span>Status:</span>{{ status }}</li>
                                            <li><span>Genre:</span>{% for category in game.categories.all %}{{category.name }}{% if not forloop.last %}, {% endif %}
                                              {% endfor %}
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-lg-6 col-md-6">
                                        <ul>
                                            <li><span>Scores:</span> 7.31 / 1,515</li>
                                            <li><span>Rating:</span> 8.5 / 161 times</li>
                                            <li><span>Views:</span> 131,541</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% if user.is_authenticated %}
                                <div class="anime__details__btn">
                                    <a href="#" class="follow-btn"><i class="fa fa-heart-o"></i>Follow</a>
                                    <a href="#" class="watch-btn" data-game-id="{{ object.id }}"><span>Loading...</span><i class="fa fa-angle-right"></i></a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 50px;" class="row">
                    <div class="col-lg-8 col-md-8">
                        <div class="anime__details__review">
                            <div class="section-title">
                                <h5>Reviews</h5>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-1.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Chris Curry - <span>1 Hour ago</span></h6>
                                    <p>whachikan Just noticed that someone categorized this as belonging to the genre
                                        "demons" LOL</p>
                                </div>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-2.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Lewis Mann - <span>5 Hour ago</span></h6>
                                    <p>Finally it came out ages ago</p>
                                </div>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-3.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Louis Tyler - <span>20 Hour ago</span></h6>
                                    <p>Where is the episode 15 ? Slow update! Tch</p>
                                </div>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-4.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Chris Curry - <span>1 Hour ago</span></h6>
                                    <p>whachikan Just noticed that someone categorized this as belonging to the genre
                                        "demons" LOL</p>
                                </div>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-5.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Lewis Mann - <span>5 Hour ago</span></h6>
                                    <p>Finally it came out ages ago</p>
                                </div>
                            </div>
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="{% static 'homepage/img/anime/review-6.jpg' %}" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <h6>Louis Tyler - <span>20 Hour ago</span></h6>
                                    <p>Where is the episode 15 ? Slow update! Tch</p>
                                </div>
                            </div>
                        </div>
                        <div class="anime__details__form">
                            <div class="section-title">
                                <h5>Your Comment</h5>
                            </div>
                            <form action="#">
                                <textarea placeholder="Your Comment"></textarea>
                                <button type="submit"><i class="fa fa-location-arrow"></i> Review</button>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4">
                        <div class="anime__details__sidebar">
                            <div class="section-title">
                                <h5>you might like...</h5>
                            </div>
                            <div class="product__sidebar__view__item set-bg" data-setbg="{% static 'homepage/img/sidebar/tv-1.jpg' %}">
                                <div class="ep">18 / ?</div>
                                <div class="view"><i class="fa fa-eye"></i> 9141</div>
                                <h5><a href="#">Boruto: Naruto next generations</a></h5>
                            </div>
                            <div class="product__sidebar__view__item set-bg" data-setbg="{% static 'homepage/img/sidebar/tv-2.jpg' %}">
                                <div class="ep">18 / ?</div>
                                <div class="view"><i class="fa fa-eye"></i> 9141</div>
                                <h5><a href="#">The Seven Deadly Sins: Wrath of the Gods</a></h5>
                            </div>
                            <div class="product__sidebar__view__item set-bg" data-setbg="{% static 'homepage/img/sidebar/tv-3.jpg' %}">
                                <div class="ep">18 / ?</div>
                                <div class="view"><i class="fa fa-eye"></i> 9141</div>
                                <h5><a href="#">Sword art online alicization war of underworld</a></h5>
                            </div>
                            <div class="product__sidebar__view__item set-bg" data-setbg="{% static 'homepage/img/sidebar/tv-4.jpg' %}">
                                <div class="ep">18 / ?</div>
                                <div class="view"><i class="fa fa-eye"></i> 9141</div>
                                <h5><a href="#">Fate/stay night: Heaven's Feel I. presage flower</a></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Anime Section End -->


    <style>
        .watch-btn.disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>

    <script>
        document.querySelectorAll('.watch-btn').forEach(btn => {
            const gameId = btn.getAttribute('data-game-id');
            
            fetch(`/api/cart/contains/?game_id=${gameId}`)
                .then(res => res.json())
                .then(data => {
                    btn.classList.remove('loading');
                    if (data.in_cart) {
                        btn.classList.add('disabled');
                        btn.querySelector('span').textContent = 'In Cart';
                    }
                    else if (data.in_library){
                        btn.classList.add('disabled');
                        btn.querySelector('span').textContent = 'In Library';
                    } else {
                        btn.querySelector('span').textContent = 'Add to cart';
                    }
                })
                .catch(err => {
                    console.error(`Error checking cart status for game ${gameId}:`, err);
                });
        });        

        document.querySelectorAll('.watch-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent link default behavior
    
                const gameId = this.getAttribute('data-game-id');
                const btn = this;
    
                fetch("{% url 'add_to_cart' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams({
                        'game_id': gameId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.already_in_cart || data.success) {
                        btn.classList.add('disabled');
                        btn.querySelector('span').textContent = 'In Cart';
                    }     
    
                    if (data.success) {
                        updateCartCount(); // Only update cart badge when new item added
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    
        // CSRF token helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(cookie => {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) {
                        cookieValue = decodeURIComponent(value);
                    }
                });
            }
            return cookieValue;
        }
    </script>    
{% endblock %}