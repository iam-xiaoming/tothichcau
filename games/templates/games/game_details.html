{% extends "homepage/base.html" %}
{% load static %}

{% block title %}
    <title>Game Detail</title>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'games/css/sidebar.css' %}">
{% endblock %}

{% block content %}
    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Anime Section Begin -->
    <section class="anime-details spad">
        <div class="container">
            <div class="anime__details__content">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="anime__details__pic set-bg" data-setbg="{{ game.image.url }}">
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="anime__details__text">
                            <div class="anime__details__title">
                                <h3>{{ game.name }}</span>
                            </div>
                            <p>{{ game.description }}</p>
                            <div class="anime__details__widget">
                                <div class="row">
                                    <div class="col-lg-6 col-md-6">
                                        <ul>
                                            <li><span>Publisher:</span>{{ game.publisher }}</li>
                                            <li><span>Date released:</span>{{ game.release_date }}</li>
                                            <li><span>Status:</span>{{ status }}</li>
                                            <li><span>Genre:</span>{% for category in game.categories.all %}{{category.name }}{% if not forloop.last %}, {% endif %}
                                              {% endfor %}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="media">
                                <button class="media-btn" onclick="openGallery()">
                                    <i class="fa-solid fa-images"></i>
                                    <span>Gallery</span>
                                </button>
                            </div>
                            {% if request.session.uid %}
                                <div class="anime__details__btn">
                                    <a href="#" class="follow-btn">Move to wishlist</a>
                                    <a href="#" class="watch-btn" data-game-id="{{ object.id }}">
                                        <span>Loading...</span>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 50px;" class="row">
                    <div class="col-lg-8 col-md-8">
                        <div class="anime__details__review">
                            <div class="section-title">
                                <h5>Reviews</h5>
                            </div>
                            {% for comment in game.comment.all %}
                                <div class="anime__review__item">
                                    <div class="anime__review__item__pic">
                                        <img src="{{ comment.user.image.url }}" alt="">
                                    </div>
                                    <div class="anime__review__item__text">
                                        <div style="display: flex;align-items:center; gap: 10px;" class="comment-info">
                                            <h6>{{ comment.user }}</h6>
                                            <span style="color: #b7b7b7; margin-bottom: 10px; font-size: 14px;">{{ comment.created_at|date:"d/m/Y" }}</span>
                                        </div>
                                        <p>{{ comment.content }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% if request.session.uid %}
                            <div class="anime__details__form">
                                <div class="section-title">
                                    <h5>Your Comment</h5>
                                </div>
                                <form action="" method="POST">
                                    {% csrf_token %}
                                    
                                    <input type="hidden" name="game_id" value="{{ game.id }}">
                                    
                                    <label style="color: #fff;" for="title">Title</label>
                                    <textarea maxlength="255" name="title" style="color: #b7b7b7; background: #202021; height: 50px; margin-bottom: 15px;" placeholder="Your title"></textarea>
                                    <label style="color: #fff;" for="content">Content</label>
                                    <textarea maxlength="1000" name="content" style="color: #b7b7b7; background: #202021;" placeholder="Your Comment"></textarea>
                                    <button type="submit"><i class="fa fa-location-arrow"></i> Review</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-lg-4 col-md-4">
                        <div class="anime__details__sidebar">
                            <div class="section-title">
                                <h5>you might like...</h5>
                            </div>
                            <div class="suggest">
                                {% for game_suggest in games_suggest %}
                                    <a href="#!">
                                        <div style="height: 150px;" class="product__sidebar__view__item set-bg" data-setbg="{{ game_suggest.image.url }}"></div>
                                        <h5 class="suggest-name">{{ game_suggest.name }}</h5>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Anime Section End -->

    <!-- Gallery Modal -->
    <div id="galleryModal" class="gallery-modal">
        <span class="close-btn" onclick="closeGallery()">&times;</span>
        <div class="gallery-content">
            <div class="iframe-wrapper">
                <div id="galleryContainer" style="width: 100%; height: 400px; overflow: hidden;"></div>
            </div>
            <div class="gallery-items-container">
                <button class="nav-btn prev-btn">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="gallery-items">
                    <!-- button -->
                </div>
                <button class="nav-btn next-btn">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const game_pk = "{{ object.pk }}";

        function getKeyCount() {
            fetch(`/api/get_key_available_count/${game_pk}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const keyCount = data.key_available_count;
        
                        document.querySelectorAll('.watch-btn').forEach(btn => {
                            btn.classList.remove('loading');
                            if (keyCount > 0) {
                                btn.classList.remove('disabled');
                                btn.querySelector('span').innerHTML = '<i class="fa-solid fa-cart-plus"></i> Add to cart'
                            } else {
                                btn.classList.add('disabled');
                                btn.querySelector('span').textContent = 'Stock out';
                            }
                        });
                    } else {
                        console.error('Failed to fetch key count');
                    }
                })
                .catch(error => {
                    console.error('Error fetching key count:', error);
                });
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            getKeyCount();
        
            document.querySelectorAll('.watch-btn').forEach(btn => {
                btn.classList.remove('loading');
                btn.classList.remove('disabled');
                btn.querySelector('span').innerHTML = '<i class="fa-solid fa-cart-plus"></i> Add to cart'
            });
        
            document.querySelectorAll('.watch-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    const btn = this;
        
                    btn.classList.add('loading');
                    btn.classList.add('disabled');
                    btn.querySelector('span').textContent = 'Adding...';
        
                    fetch(`/api/cart/add/${user_pk}/${game_pk}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: new URLSearchParams({
                            'game_id': game_pk,
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateCartCount(data.order_count);
                            
                            // update add to cart btn
                            if (data.key_remain > 0) {
                                btn.classList.remove('loading');
                                btn.classList.add('disabled');
                                btn.querySelector('span').innerHTML = '<i class="fa-solid fa-cart-plus"></i> Add to cart'
                            } else {
                                btn.classList.remove('loading');
                                btn.classList.add('disabled');
                                btn.querySelector('span').textContent = 'Stock out';
                            }
                        } else {
                            btn.classList.remove('loading');
                            btn.classList.add('disabled');
                            btn.querySelector('span').textContent = 'Stock out';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        btn.classList.remove('loading');
                        btn.classList.remove('disabled');
                        btn.querySelector('span').textContent = 'Error';
                    });
                });
            });
        });        


        // CSRF token helper
        function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    document.cookie.split(';').forEach(cookie => {
                        const [key, value] = cookie.trim().split('=');
                        if (key === name) {
                            cookieValue = decodeURIComponent(value);
                        }
                    });
                }
                return cookieValue;
            }
    </script>   
    <script src="{% static 'games/js/gallery.js' %}"></script>
{% endblock %}